FROM postgres:9.4

RUN apt-get update \
    && apt-get install -y python-dev lzop pv daemontools curl build-essential \
    && curl --silent --show-error --retry 5 https://bootstrap.pypa.io/get-pip.py | python \
    && pip install wal-e

RUN curl -L http://www.xunsearch.com/scws/down/scws-1.2.2.tar.bz2 | tar xjf - 
RUN cd scws-1.2.2 \
    && ./configure \
    && make install

RUN apt-get install --yes postgresql-server-dev-9.4 libpq-dev unzip

RUN curl -L https://github.com/amutu/zhparser/archive/de966445dab64b91378527219988f36107b7b2e8.zip > zhparser-de966445dab64b91378527219988f36107b7b2e8.zip

RUN unzip zhparser-de966445dab64b91378527219988f36107b7b2e8 

RUN cd zhparser-de966445dab64b91378527219988f36107b7b2e8 \
    && SCWS_HOME=/usr/local make && make install

RUN apt-get remove -y build-essential python-dev \
    && apt-get autoremove -y \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ADD make_db.sh /docker-entrypoint-initdb.d/
ADD setup-wale.sh /docker-entrypoint-initdb.d/
COPY docker-entrypoint1.sh /
RUN chmod +x /docker-entrypoint1.sh

ENTRYPOINT ["/docker-entrypoint1.sh"]

CMD ["postgres"]
